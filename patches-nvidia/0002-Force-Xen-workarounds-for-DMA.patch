From 8ec2c5438c18f26f24ebd12b2651ba6e13957d8b Mon Sep 17 00:00:00 2001
From: Benjamin Leggett <benjamin@edera.io>
Date: Tue, 29 Jul 2025 15:18:47 -0400
Subject: [PATCH] Force Xen workarounds for DMA

---
 kernel-open/common/inc/nv-linux.h |  3 +++
 kernel-open/conftest.sh           | 13 +++++++------
 2 files changed, 10 insertions(+), 6 deletions(-)

diff --git a/kernel-open/common/inc/nv-linux.h b/kernel-open/common/inc/nv-linux.h
index 0cdcabc2..a3f01512 100644
--- a/kernel-open/common/inc/nv-linux.h
+++ b/kernel-open/common/inc/nv-linux.h
@@ -88,6 +88,9 @@
 #define VM_DONTDUMP    0x00000000
 #endif
 
+// EDERA: Force this on for zone kernels
+#define NV_DOM0_KERNEL_PRESENT
+
 #include <linux/init.h>             /* module_init, module_exit         */
 #include <linux/types.h>            /* pic_t, size_t, __u32, etc        */
 #include <linux/errno.h>            /* error codes                      */
diff --git a/kernel-open/conftest.sh b/kernel-open/conftest.sh
index 796e892d..2420326a 100755
--- a/kernel-open/conftest.sh
+++ b/kernel-open/conftest.sh
@@ -767,12 +767,13 @@ compile_test() {
             compile_check_conftest "$CODE" "NV_IOREMAP_CACHE_SHARED_PRESENT" "" "functions"
         ;;
         dom0_kernel_present)
-            # Add config parameter if running on DOM0.
-            if [ -n "$VGX_BUILD" ]; then
-                echo "#define NV_DOM0_KERNEL_PRESENT" | append_conftest "generic"
-            else
-                echo "#undef NV_DOM0_KERNEL_PRESENT" | append_conftest "generic"
-            fi
+            # EDERA: Drop this
+            # # Add config parameter if running on DOM0.
+            # if [ -n "$VGX_BUILD" ]; then
+            #     echo "#define NV_DOM0_KERNEL_PRESENT" | append_conftest "generic"
+            # else
+            #     echo "#undef NV_DOM0_KERNEL_PRESENT" | append_conftest "generic"
+            # fi
             return
         ;;
 
-- 
2.50.1

